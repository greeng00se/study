# 데이터 접근 기술2 - 트랜잭션 전파

### 히카리 커넥션 풀 커넥션 획득

- 히카리 커넥션 풀에서 커넥션을 획득하면 실제 DB와의 커넥션을 그대로 반환하는 것이 아니다.
- 내부 관리를 위해 히카리 프록시 커넥션이라는 객체를 생성해서 반환한다.
- 히카리 프록시 커넥션은 항상 새로 생성해서 반환을 한다.

### 스프링의 트랜잭션

- 스프링은 이해를 돕리 위해 논리 트랜잭션과 물리 트랜잭션으로 나뉜다.
    - 논리 트랜잭션은 트랜잭션 매니저를 통해 트랜잭션을 사용하는 단위다.
    - 물리 트랜잭션은 우리가 이해하는 실제 데이터베이스에 적용되는 트랜잭션이다.
- 트랜잭션이 두 개 이상일 때에만 적용이 되며 이 때 하나의 물리 트랜잭션은 여러 개의 논리 트랜잭션을 포함한다.
- 원칙
    - 모든 논리 트랜잭션이 커밋되어야 물리 트랜잭션이 커밋된다.
    - 하나의 논리 트랜잭션이라도 롤백된다면 물리 트랜잭션은 롤백된다.
- 처음 시작한 외부 트랜잭션이 실제 물리 트랜잭션을 관리하도록 한다.

### 내부 트랜잭션 롤백

- 외부 트랜잭션과 내부 트랜잭션이 존재한다고 가정
- 외부 시작 → 내부 시작 → 내부 롤백 → 외부 커밋 일 때
- 내부 트랜잭션이 롤백된다면 실제 물리 트랜잭션은 롤백하지는 않고, 트랜잭션을 롤백 전용으로 표시한다.
- 외부 트랜잭션은 롤백 전용 트랜잭션에서 커밋했기 때문에 `UnexpectedRollbackException` 런타임 예외를 던진다.

### REQUIRES_NEW

- 물리 트랜잭션을 분리하는 방법

### 전파 옵션

- `REQUIRED` → 기본 설정
    - 트랜잭션이 없으면 생성하고, 있으면 참여한다.
    - 실무에서 대부분 사용
- `REQUIRES_NEW`
    - 항상 새로운 트랜잭션 생성
- `SUPPORT`
    - 트랜잭션 지원, 기존 트랜잭션이 없으면 없는대로 진행, 있으면 참여
- `NOT_SUPPORT`
    - 트랜잭션 지원하지 않음
- `MANDATORY`
    - 의무사항, 트랜잭션이 반드시 있어야 한다.
    - 없으면 예외가 밸상한다.
- `NEVER`
    - 트랜잭션을 사용하지 않는다.
    - 기존 트랜잭션이 있으면 예외가 발생한다.
- `NESTED`
    - 기존 트랜잭션 없으면 새로운 트랜잭션을 생성한다.
    - 없으면 중첩 트랜잭션을 만든다.
        - 중첩 트랜잭션은 외부 트랜잭션의 영향을 받는다.
        - 중첩 트랜잭션은 외부에 영향을 주지 않는다.

### 트랜잭션 전파와 옵션

- `isolation`, `timeout`, `readOnly`는 트랜잭션이 처음 시작될 때만 적용된다.