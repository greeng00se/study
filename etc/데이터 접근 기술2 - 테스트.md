# 데이터 접근 기술2 - 테스트

### PlatformTransactionManager 사용

- 트랜잭션과 롤백 전략을 이용하여 테스트를 하는 것이 중요하다.

```java
@Autowired
PlatformTransactionManager transactionManager;
TransactionStatus status;

@BeforeEach
void beforeEach() {
    // start transaction
    status = transactionManager.getTransaction(new DefaultTransactionDefinition());
}

@AfterEach
void afterEach() {
    // end transaction
    transactionManager.rollback(status);
}
```

### @Transactional 애노테이션

```java
@Transactional
@SpringBootTest
class xxxRepositoryTest {
    ...
}
```

- 스프링이 제공하는 @Transactional 로직은 성공적으로 수행되면 커밋하도록 동작한다.
- 테스트에 해당 애노테이션을 사용한다면 테스트가 트랜잭션 안에서 실행하고, 테스트가 종료된다면 트랜잭션을 자동으로 롤백시킨다.

### 메모리 db 사용

```java
@Slf4j
@Import(JdbcTemplateV3Config.class)
@SpringBootApplication(scanBasePackages = "hello.itemservice.web")
public class ItemServiceApplication {

	public static void main(String[] args) {
		SpringApplication.run(ItemServiceApplication.class, args);
	}

	@Bean
	@Profile("test")
	public DataSource dataSource() {
		log.info("메모리 데이터베이스 초기화");
		DriverManagerDataSource dataSource = new DriverManagerDataSource();
		dataSource.setDriverClassName("org.h2.Driver");
		dataSource.setUrl("jdbc:h2:mem:db;DB_CLOSE_DELAY=-1");
		dataSource.setUsername("sa");
		dataSource.setPassword("");
		return dataSource;
	}
}
```

- test 환경에서 사용할 DataSource 빈을 설정해줘야 한다.
- 임베디드 모드에서 데이터베이스 커넥션이 모두 끊어지면 데이터베이스가 종료되는데 방지하기 위해 DB_CLOSE_DELAY=-1를 넣어야 한다.

```sql
// /test/resources/schema.sql
drop table if exists item CASCADE;
create table item
(
    id        bigint generated by default as identity,
    item_name varchar(10),
    price     integer,
    quantity  integer,
    primary key (id)
);
```

### 스프링 부트의 임베디드 모드

```sql
spring.profiles.active=test
#spring.datasource.url=jdbc:h2:tcp://localhost/~/testcase
#spring.datasource.username=sa
#spring.datasource.password=
```

- 데이터 소스를 설정하지 않으면 기본적으로 스프링 부트가 자동으로 생성해준다.