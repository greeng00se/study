> í† ë¹„ì˜ ìŠ¤í”„ë§ 3.1ì„ ì½ê³  ì •ë¦¬í•œ ê¸€ì…ë‹ˆë‹¤.
> 

## 5. ì„œë¹„ìŠ¤ ì¶”ìƒí™”

### ëª©ì 

- ìŠ¤í”„ë§ì´ ì–´ë–»ê²Œ ë¹„ìŠ·í•œ ì—¬ëŸ¬ ì¢…ë¥˜ì˜ ê¸°ìˆ ì„ ì¶”ìƒí™”í•˜ê³  ì¼ê´€ëœ ë°©ë²•ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ”ì§€ ìƒê°í•˜ê¸°

### ì½”ë“œ ê°œì„ ì„ ìœ„í•œ ì²´í¬ ë¦¬ìŠ¤íŠ¸

- ì½”ë“œì— ì¤‘ë³µëœ ë¶€ë¶„ì€ ì—†ëŠ”ê°€?
- ì½”ë“œê°€ ë¬´ì—‡ì„ í•˜ëŠ” ê²ƒì¸ì§€ ì´í•´í•˜ê¸° ë¶ˆí¸í•˜ì§€ ì•Šì€ê°€?
- ì½”ë“œê°€ ìì‹ ì´ ìˆì–´ì•¼ í•  ìë¦¬ì— ìˆëŠ”ê°€?
- ì•ìœ¼ë¡œ ë³€ê²½ì´ ì¼ì–´ë‚œë‹¤ë©´ ì–´ë–¤ ê²ƒì´ ìˆì„ ìˆ˜ ìˆê³ , ê·¸ ë³€í™”ì— ì‰½ê²Œ ëŒ€ì‘í•  ìˆ˜ ìˆê²Œ ì‘ì„±ë˜ì–´ ìˆëŠ”ê°€?

## 5.1 íŠ¸ëœì­ì…˜ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

- ì±…ì—ì„œì˜ ìš”êµ¬ì‚¬í•­
    - ì‚¬ìš©ì ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œë¥¼ ì‹œë„í•˜ê±°ë‚˜ ì¤‘ê°„ì— ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´, ê·¸ ì „ì— ì—…ê·¸ë ˆì´ë“œ í–ˆë˜ ì‚¬ìš©ìë¥¼ ë‹¤ì‹œ ì›ë˜ ìƒíƒœë¡œ ëŒì•„ê°€ë„ë¡ í•˜ëŠ” ê²ƒ
    - ì‹¤íŒ¨ ì›ì¸ â†’ `upgradeLevels()` ë©”ì†Œë“œì˜ ì‘ì—…ì´ íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ì§€ ì•Šì•˜ìŒ

> ğŸ“ŒÂ  íŠ¸ëœì­ì…˜(Transaction)
> 
> - ë” ì´ìƒ ë‚˜ëˆŒ ìˆ˜ ì—†ëŠ” ë‹¨ìœ„ ì‘ì—…
> - ì‘ì—…ì„ ìª¼ê°œì„œ ì‘ì€ ë‹¨ìœ„ë¡œ ë§Œë“¤ ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒì€ íŠ¸ëœì­ì…˜ì˜ í•µì‹¬ ì†ì„±ì¸ ì›ìì„±ì„ ì˜ë¯¸í•œë‹¤.

> ğŸ“ŒÂ  íŠ¸ëœì­ì…˜ì˜ íŠ¹ì§•(ACID)
> 
> - ì›ìì„±(Atomicity)
>     - íŠ¸ëœì­ì…˜ì˜ ëª¨ë“  ì—°ì‚°ë“¤ì´ ì •ìƒì ìœ¼ë¡œ ìˆ˜í–‰ ì™„ë£Œë˜ê±°ë‚˜ ì•„ë‹ˆë©´ ì „í˜€ ì–´ë– í•œ ì—°ì‚°ë„ ìˆ˜í–‰ë˜ì§€ ì•Šì€ ìƒíƒœë¥¼ ë³´ì¥í•´ì•¼ í•œë‹¤.
>     - All or Nothing
> - ì¼ê´€ì„±(Consistency)
>     - íŠ¸ëœì­ì…˜ì˜ ì‘ì—… ì²˜ë¦¬ ê²°ê³¼ëŠ” í•­ìƒ ì¼ê´€ì„±ì´ ìˆì–´ì•¼ í•œë‹¤.
> - ë…ë¦½ì„±(Isolation)
>     - ê°ê°ì˜ íŠ¸ëœì­ì…˜ì€ ë…ë¦½ì ì´ë¼ ì„œë¡œ ê°„ì„­ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤.
> - ì§€ì†ì„±(Durability)
>     - íŠ¸ëœì­ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ë©´ ì˜êµ¬ì ìœ¼ë¡œ ê²°ê³¼ì— ë°˜ì˜ë˜ì–´ì•¼ í•œë‹¤.
>     - commitì´ ëœë‹¤ë©´ ì§€ì†ì„±ì„ ë§Œì¡±í•œë‹¤.

> ğŸ“ŒÂ  ì„œë¹„ìŠ¤ ì¶”ìƒí™”(Service abstraction)
> 
> - ê¸°ëŠ¥ì€ ìœ ì‚¬í•˜ë‚˜ ì‚¬ìš© ë°©ë²•ì´ ë‹¤ë¥¸ ë¡œìš°ë ˆë²¨ì˜ ë‹¤ì–‘í•œ ê¸°ìˆ ì— ëŒ€í•´ ì¶”ìƒ ì¸í„°í˜ì´ìŠ¤ì™€ ì¼ê´€ì„± ìˆëŠ” ì ‘ê·¼ ë°©ë²•ì„ ì œê³µí•˜ëŠ” ê²ƒ
> - ëŒ€í‘œì ì¸ ì˜ˆì‹œë¡œ íŠ¸ëœì­ì…˜ ì„œë¹„ìŠ¤ ì¶”ìƒí™”ê°€ ìˆë‹¤.

### íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •

- DBëŠ” ì™„ë²½í•œ íŠ¸ëœì­ì…˜ì„ ì§€ì›í•œë‹¤.
- ì—¬ëŸ¬ê°œì˜ ë¡œìš°ë¥¼ ì‚­ì œí•˜ëŠ” SQL 1ê°œë¥¼ ì‹¤í–‰í–ˆì„ ë•Œ, ì¼ë¶€ ë¡œìš°ë§Œ ì‚­ì œë˜ê³  ì‹¤íŒ¨ë¡œ ëë‚˜ëŠ” ê²½ìš°ê°€ ì—†ë‹¤.
    - í•˜ë‚˜ì˜ SQL ëª…ë ¹ì„ ì²˜ë¦¬í•˜ëŠ” ê²½ìš° â†’ DBê°€ íŠ¸ëœì­ì…˜ì„ ë³´ì¥
- ì€í–‰ ì‹œìŠ¤í…œì˜ ê³„ì¢Œì´ì²´ ì‘ì—…ê³¼ ê°™ì´ ì—¬ëŸ¬ ê°œì˜ SQLì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì·¨ê¸‰í•´ì•¼ í•˜ëŠ” ê²½ìš°ë„ ì¡´ì¬í•œë‹¤.
    - ì„ê¸ˆ, ì¶œê¸ˆ ë‘ ê°œì˜ SQLì´ ìˆë‹¤ê³  ê°€ì •í–ˆì„ ë•Œ
    - ë‘ ë²ˆì§¸ SQLì´ ì‹¤í–‰ë  ë•Œ ë¬¸ì œê°€ ìƒê¸°ëŠ” ê²½ìš° â†’ ì•ì— ì²˜ë¦¬í•œ SQLë„ ì·¨ì†Œí•´ì•¼ í•œë‹¤.(íŠ¸ëœì­ì…˜ ë¡¤ë°±)
    - ëª¨ë‘ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ëŠ” ê²½ìš° â†’ DBì—ê²Œ ì„±ê³µí–ˆë‹¤ê³  ì•Œë ¤ì¤˜ì„œ ì‘ì—…ì„ í™•ì •ì‹œí‚¨ë‹¤.(íŠ¸ëœì­ì…˜ ì»¤ë°‹)
    

### JDBC íŠ¸ëœì­ì…˜ì˜ íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •

- ëª¨ë“  íŠ¸ëœì­ì…˜ì€ ì‹œì‘í•˜ëŠ” ì§€ì ê³¼ ëë‚˜ëŠ” ì§€ì ì´ ìˆë‹¤.
- JDBCì˜ íŠ¸ëœì­ì…˜ì€ í•˜ë‚˜ì˜ Connectionì„ ê°€ì ¸ì™€ ì‚¬ìš©í•˜ë‹¤ê°€ ë‹«ëŠ” ì‚¬ì´ì— ì¼ì–´ë‚œë‹¤.
    - íŠ¸ëœì­ì…˜ì˜ ì‹œì‘ê³¼ ì¢…ë£ŒëŠ” Connection ì˜¤ë¸Œì íŠ¸ë¥¼ í†µí•´ ì´ë£¨ì–´ ì§„ë‹¤.
    - ê¸°ë³¸ì ìœ¼ë¡œ DB ì‘ì—…ì„ ìˆ˜í–‰í•œ ì§í›„ì— ìë™ìœ¼ë¡œ ì»¤ë°‹ì´ ë˜ë„ë¡ ì„¤ì •ë˜ì–´ ìˆë‹¤.
- JDBCì˜ ìë™ ì»¤ë°‹ ê¸°ëŠ¥ì„ `setAutoCommit(false)` ë©”ì„œë“œë¥¼ ì´ìš©í•˜ì—¬ `false`ë¡œ ì„¤ì •í•˜ë©´ ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ì´ ì‹œì‘ë˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆë‹¤.
- `commit()` ë˜ëŠ” `rollback()` ì´ í˜¸ì¶œë˜ê¸° ì „ê¹Œì§€ì˜ ì‘ì—…ì´ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ì¸ë‹¤. í•´ë‹¹ ë©”ì„œë“œê°€ í˜¸ì¶œë˜ë©´ íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œëœë‹¤.

> ğŸ“ŒÂ  íŠ¸ëœì­ì…˜ ê²½ê³„(Transaction Demarcation)
> 
> - ì• í”Œë¦¬ì¼€ì´ì…˜ ë‚´ì—ì„œ íŠ¸ëœì­ì…˜ì´ ì‹œì‘ë˜ê³  ëë‚˜ëŠ” ìœ„ì¹˜

### ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë‚´ì˜ íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •

- ì±…ì˜ ì½”ë“œ ê¸°ì¤€ìœ¼ë¡œ UserServiceì™€ UserDaoë¥¼ ê·¸ëŒ€ë¡œ ë‘” ì±„ë¡œ íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ë ¤ë©´ íŠ¸ëœì­ì…˜ì˜ ê²½ê³„ì„¤ì • ì‘ì—…ì„ ì„œë¹„ìŠ¤ ìª½ìœ¼ë¡œ ê°€ì ¸ì™€ì•¼ í•œë‹¤.
- UserDaoê°€ ê°€ì§„ SQL, JDBC APIë¥¼ ì´ìš©í•œ ë°ì´í„° ì•¡ì„¸ìŠ¤ ì½”ë“œëŠ” ìµœëŒ€í•œ ë‚¨ê²¨ë‘” ì±„ë¡œ, UserServiceì—ëŠ” Connectionì„ ì´ìš©í•˜ì—¬ íŠ¸ëœì­ì…˜ì˜ ì‹œì‘ê³¼ ì¢…ë£Œë¥¼ ë‹´ë‹¹í•˜ëŠ” ìµœì†Œí•œì˜ ì½”ë“œë§Œ ê°€ì ¸ì˜¤ê²Œ ë§Œë“¤ë©´ ë¬¸ì œë¥¼ í•´ê²° í•  ìˆ˜ ìˆë‹¤.

```java
public void upgradeLevels() throws Exception {
    Connection c = dataSource.getConnection()
    c.setAutoCommit(false);
    try {
        ...
        upgradeLevel(c, user);
        ...
        c.commit();
    } catch(Exception e) {
        c.rollback();
        throw e;
    } finally {
        c.close();
    }
}
```

- Connectionì„ ì‚¬ìš©í•˜ëŠ” íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì • êµ¬ì¡°

> â—Â  Connectionì„ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •ì˜ ë¬¸ì œì 
> 
> - DB ì»¤ë„¥ì…˜ì„ ì´ìš©í•´ì„œ ë¦¬ì†ŒìŠ¤ë¥¼ ê¹”ë”í•˜ê²Œ ì²˜ë¦¬í•˜ëŠ” JdbcTemplateì„ ì‚¬ìš©í•˜ì§€ ëª»í•˜ê³  try/catch/finally ì½”ë“œë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
> - Connection Objectë¥¼ ì „ë‹¬ ë°›ì•„ ì‚¬ìš©í•¨ìœ¼ë¡œ ì½”ë“œê°€ ì§€ì €ë¶„í•´ì§„ë‹¤.
> - Connection íŒŒë¼ë¯¸í„°ê°€ ì¸í„°í˜ì´ìŠ¤ ë©”ì†Œë“œì— ì¶”ê°€ë˜ë©´ì„œ DB ì ‘ê·¼ ê¸°ìˆ ì— ë…ë¦½ì ì´ì§€ ëª»í•˜ê²Œ ëœë‹¤.

### íŠ¸ëœì­ì…˜ ë™ê¸°í™”

- ìŠ¤í”„ë§ì€ `TransactionSynchronizationManager`ë¥¼ í†µí•´ ë©€í‹°ì“°ë ˆë“œ í™˜ê²½ì—ì„œë„ ì•ˆì „í•œ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ê¸°ëŠ¥ì„ ì œê³µí•´ì¤€ë‹¤.
- `DataSourceUtils.getConnection()` ë©”ì„œë“œëŠ” Connection ì˜¤ë¸Œì íŠ¸ë¥¼ ìƒì„±ê³¼ ë™ì‹œì— íŠ¸ëœì­ì…˜ ë™ê¸°í™”ì— ì‚¬ìš©í•˜ë„ë¡ í•´ì¤€ë‹¤.

```java
package springbook.user.service;

public class UserService {

    private UserDao userDao;
    private DataSource dataSource;

    public void setUserDao(UserDao userDao) {
        this.userDao = userDao;
    }

    public void setDataSource(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    public void upgradeLevels() throws Exception {
        // íŠ¸ëœì­ì…˜ ë™ê¸°í™” ê´€ë¦¬ìë¥¼ ì´ìš©í•´ ë™ê¸°í™” ì‘ì—… ì´ˆê¸°í™” 
        TransactionSynchronizationManager.initSynchronization();
        // db ì»¤ë„¥ì…˜ ìƒì„± ë° íŠ¸ëœì­ì…˜ ì‹œì‘
        Connection c = DataSourceUtils.getConnection(dataSource);
        c.setAutoCommit(false);
        try {
            List<User> users = userDao.getAll();

            for (User user : users) {
                if (canUpgradeLevel(user)) {
                    upgradeLevel(user);
                }
            }
            c.commit();
        } catch (Exception e) {
            c.rollback();
            throw e;
        } finally {
            // db ì»¤ë„¥ì…˜ ì¢…ë£Œ
            DataSourceUtils.releaseConnection(c, dataSource);
            // ë™ê¸°í™” ì‘ì—… ì¢…ë£Œ ë° ì •ë¦¬
            TransactionSynchronizationManager.unbindResource(this.dataSource);
            TransactionSynchronizationManager.clearSynchronization();
        }
    }
}
```

- íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë°©ì‹ì„ ì ìš©í•œ UserService

> ğŸ“ŒÂ  íŠ¸ëœì­ì…˜ ë™ê¸°í™”(Transaction Synchronization)
> 
> - íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê¸° ìœ„í•œ Connection ê°ì²´ë¥¼ íŠ¹ë³„í•œ ì¥ì†Œì— ì €ì¥í•´ë‘ê³  í•„ìš”í•  ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•˜ëŠ” ê¸°ìˆ 
> - ì‘ì—… ì“°ë ˆë“œë§ˆë‹¤ Connection ê°ì²´ë¥¼ ë…ë¦½ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê¸° ë•Œë¬¸ì— ë©€í‹°ì“°ë ˆë“œ í™˜ê²½ì—ì„œë„ ì•ˆì „í•˜ë‹¤.

### JdbcTemplaeê³¼ íŠ¸ëœì­ì…˜ ë™ê¸°í™”

- JdbcTemplateì€ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì €ì¥ì†Œì— ë“±ë¡ëœ DB ì»¤ë„¥ì…˜ì´ë‚˜ íŠ¸ëœì­ì…˜ì´ ì—†ëŠ” ê²½ìš°ì—ëŠ” ì§ì ‘ DB ì»¤ë„¥ì…˜ì„ ë§Œë“¤ê³  íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•´ì„œ ì‘ì—…ì„ ì§„í–‰í•œë‹¤.

### íŠ¸ëœì­ì…˜ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

- í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ì—¬ëŸ¬ ê°œì˜ DBì— ë°ì´í„°ë¥¼ ë„£ëŠ” ì‘ì—…ì€ Jdbcì˜ Connectionì„ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ë°©ì‹ì¸ ë¡œì»¬ íŠ¸ëœì­ì…˜ìœ¼ë¡œëŠ” ë¶ˆê°€ëŠ¥í•˜ë‹¤.
- ë³„ë„ì˜ íŠ¸ëœì­ì…˜ ê´€ë¦¬ìë¥¼ í†µí•´ íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬í•˜ëŠ” ê¸€ë¡œë²Œ íŠ¸ëœì­ì…˜ ë°©ì‹ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
- ìë°”ëŠ” JDBCì™¸ì— ê¸€ë¡œë²Œ íŠ¸ëœì­ì…˜ì„ ì§€ì›í•˜ëŠ” íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì§€ì›í•˜ê¸° ìœ„í•œ APIì¸ JTAë¥¼ ì œê³µí•œë‹¤.
- JTA(Java Transaction API)ë¥¼ ì‚¬ìš©í•˜ë©´ ì—¬ëŸ¬ ê°œì˜ DBë‚˜ ë©”ì‹œì§• ì„œë²„ì— ëŒ€í•œ ì‘ì—…ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ í†µí•©í•˜ëŠ” ë¶„ì‚° íŠ¸ëœì­ì…˜ ë˜ëŠ” ê¸€ë¡œë²Œ íŠ¸ëœì­ì…˜ì´ ê°€ëŠ¥í•´ì§„ë‹¤.

> â—Â  JTAë¥¼ ì‚¬ìš©í•œ íŠ¸ëœì­ì…˜ì˜ ë¬¸ì œì 
> 
> - JDBCë¥¼ ì‚¬ìš©í•˜ëŠ” ë¡œì»¬ íŠ¸ëœì­ì…˜ ì½”ë“œì™€ JTAë¥¼ ì´ìš©í•˜ëŠ” ê¸€ë¡œë²Œ íŠ¸ëœì­ì…˜ ì½”ë“œê°€ ë‹¤ë¥´ë‹¤. ë”°ë¼ì„œ ë°ì´í„° ì ‘ê·¼ ê¸°ìˆ ì— ì¢…ì†ë˜ëŠ” ì½”ë“œê°€ ë˜ì–´ë²„ë¦°ë‹¤.
> - Hibernateë¥¼ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ê´€ë¦¬ì½”ë“œëŠ” JDBCì™€ JTAì™€ ë˜ ë‹¤ë¥´ë‹¤.
> - ë”°ë¼ì„œ ë¡œì»¬ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì¶©ë¶„í•œ í™˜ê²½ì˜ ì½”ë“œì™€ ë‹¤ì¤‘ DBë¥¼ ì‚¬ìš©í•  ë•Œì˜ ì½”ë“œê°€ ë‹¬ë¼ì§€ê¸° ë•Œë¬¸ì— íŠ¸ëœì­ì…˜ ì„œë¹„ìŠ¤ë¥¼ ì¶”ìƒí™”í•  í•„ìš”ê°€ ìˆë‹¤.

> ğŸ“ŒÂ  ê¸€ë¡œë²Œ íŠ¸ëœì­ì…˜(Global Transacton)
> 
> - ë¶„ì‚° íŠ¸ëœì­ì…˜(XA, Distributed Transaction)ì´ë¼ê³ ë„ ë¶ˆë¦°ë‹¤.
> - íŠ¸ëœì­ì…˜ì— ì°¸ì—¬í•œ ì—¬ëŸ¬ ë…ë¦½ì ì¸ ì¼ë“¤ ì¤‘ í•˜ë‚˜ë¼ë„ ë‹¤ë¥¸ ë¦¬ì†ŒìŠ¤ì—ì„œ ì¼ì–´ë‚˜ëŠ” ê²½ìš°ë‹¤.

### ìŠ¤í”„ë§ì˜ íŠ¸ëœì­ì…˜ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

- ìŠ¤í”„ë§ì€ íŠ¸ëœì­ì…˜ ê¸°ìˆ ì˜ ê³µí†µì ì„ ë‹´ì€ íŠ¸ëœì­ì…˜ ì¶”ìƒí™” ê¸°ìˆ ì„ ì œê³µí•œë‹¤.
- `PlatformTransactionManager`ëŠ” ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •ì„ ìœ„í•œ ì¶”ìƒ ì¸í„°í˜ì´ìŠ¤ë‹¤.
- JDBCì˜ ë¡œì»¬ íŠ¸ëœì­ì…˜ì„ ì´ìš©í•œë‹¤ë©´ `PlatformTransactionManager`ë¥¼ êµ¬í˜„í•œ `DataSourceTransactionManager`ì„ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

```java
public class UserService {

    ...
    private PlatformTransactionManager transactionManager;

    public void setTransactionManager(PlatformTransactionManager transactionManager) {
        this.transactionManager = transactionManager;
    }

    public void upgradeLevels() throws Exception {
        TransactionStatus status = this.transactionManager.getTransaction(new DefaultTransactionDefinition());
        try {
            List<User> users = userDao.getAll();

            for (User user : users) {
                if (canUpgradeLevel(user)) {
                    upgradeLevel(user);
                }
            }
            this.transactionManager.commit(status);
        } catch (Exception e) {
            this.transactionManager.rollback(status);
            throw e;
        }
    }
}
```

- `PlatformTransactionManager`ë¥¼ ì‚¬ìš©í•œ `UserService`

## 5.2 ì„œë¹„ìŠ¤ ì¶”ìƒí™”ì™€ ë‹¨ì¼ ì±…ì„ ì›ì¹™

### ìˆ˜ì§, ìˆ˜í‰ ê³„ì¸µêµ¬ì¡°ì™€ ì˜ì¡´ê´€ê³„

- ê¸°ìˆ ê³¼ ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì¶”ìƒí™” ê¸°ë²•ì„ ì´ìš©í•˜ë©´ íŠ¹ì • ê¸°ìˆ í™˜ê²½ì— ì¢…ì†ë˜ì§€ ì•ŠëŠ” ì½”ë“œë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.
- ìŠ¤í”„ë§ì˜ DIê°€ ìˆê¸° ë•Œë¬¸ì— ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ì˜ ì¢…ë¥˜ì— ë”°ë¥¸ ìˆ˜í‰ì ì¸ êµ¬ë¶„ì´ë“ , ë¡œì§ê³¼ ê¸°ìˆ ì´ë¼ëŠ” ìˆ˜ì§ì ì¸ êµ¬ë¶„ì´ë“  ëª¨ë‘ ê²°í•©ë„ê°€ ë‚®ìœ¼ë©°, ì„œë¡œ ì˜í–¥ì„ ì£¼ì§€ ì•Šê³  ììœ ë¡­ê²Œ í™•ì¥ ë ìˆ˜ ìˆëŠ” êµ¬ì¡°ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.
- DIì˜ ê°€ì¹˜ëŠ” ê´€ì‹¬, ì±…ì„, ì„±ê²©ì´ ë‹¤ë¥¸ ì½”ë“œë¥¼ ë¶„ë¦¬í•˜ëŠ” ë° ìˆë‹¤.

### ë‹¨ì¼ ì±…ì„ ì›ì¹™

- ì ì ˆí•œ ë¶„ë¦¬ê°€ ê°€ì ¸ì˜¤ëŠ” íŠ¹ì§•ì€ ê°ì²´ì§€í–¥ ì„¤ê³„ì˜ ì›ì¹™ ì¤‘ì˜ í•˜ë‚˜ì¸ ë‹¨ì¼ ì±…ì„ ì›ì¹™ìœ¼ë¡œ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤.
- ë‹¨ì¼ ì±…ì„ ì›ì¹™ì„ ì§€í‚¤ëŠ” ì½”ë“œëŠ” ê¸°ìˆ ì ì¸ ìˆ˜ì •ì‚¬í•­ì´ë“  ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ ë³€ê²½ì´ë“  ë³€ê²½ì´ í•„ìš”í•  ë•Œ ìˆ˜ì • ëŒ€ìƒì´ ëª…í™•í•´ì§„ë‹¤.
- ë‹¨ì¼ ì±…ì„ ì›ì¹™ì„ ì˜ ì§€í‚¤ëŠ” ì½”ë“œë¥¼ ë§Œë“œë ¤ë©´ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë„ì…í•˜ê³  DIë¡œ ì—°ê²°í•´ì•¼ í•˜ë©°, ê·¸ ê²°ê³¼ë¡œ ë‹¨ì¼ ì±…ì„ ì›ì¹™ ë¿ ì•„ë‹ˆë¼ ê°œë°© íì‡„ ì›ì¹™ë„ ì˜ ì§€í‚¤ê³ , ëª¨ë“ˆ ê°„ ê²°í•©ë„ê°€ ë‚®ì•„ì„œ ì„œë¡œì˜ ë³€ê²½ì´ ì˜í–¥ì„ ì£¼ì§€ ì•Šê³ , ê°™ì€ ì´ìœ ë¡œ ë³€ê²½ì´ ë‹¨ì¼ ì±…ì„ì— ì§‘ì¤‘ë˜ëŠ” ì‘ì§‘ë„ ë†’ì€ ì½”ë“œê°€ ë‚˜ì˜¨ë‹¤.

> ğŸ“ŒÂ  ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP, Single Responsibility Principle)
> 
> - í•˜ë‚˜ì˜ ëª¨ë“ˆì€ í•œ ê°€ì§€ ì±…ì„ì„ ê°€ì ¸ì•¼ í•œë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.
> - í•˜ë‚˜ì˜ ëª¨ë“ˆì´ ë°”ë€ŒëŠ” ì´ìœ ëŠ” í•œ ê°€ì§€ì—¬ì•¼ í•œë‹¤.

## 5.3 ë©”ì¼ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

```java
implementation 'org.springframework.boot:spring-boot-starter-mail'
```

- Gradleì— ìœ„ì™€ ê°™ì´ ì˜ì¡´ì„±ì„ ì¶”ê°€í•˜ë©´ ë©”ì¼ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

### ë©”ì¼ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

- ìë°”ì—ì„œ ë©”ì¼ì„ ë°œì†¡í•  ë•ŒëŠ” í‘œì¤€ ê¸°ìˆ ì¸ JavaMailì„ ì‚¬ìš©í•˜ë©´ ëœë‹¤.
- ë©”ì¼ ì „ì†¡ì„ ìˆ˜í–‰í•˜ëŠ” JavaMailì˜ ì½”ë“œë¥¼ í…ŒìŠ¤íŠ¸ í•˜ê¸° ìœ„í•´ì„œ JavaMailê³¼ ê°™ì€ ì¸í„°í˜ì´ìŠ¤ë¥¼ ê°€ì§€ëŠ” ì˜¤ë¸Œì íŠ¸ë¥¼ ë§Œë“¤ì–´ì„œ ì‚¬ìš©í•˜ë©´ ê°„ë‹¨íˆ í…ŒìŠ¤íŠ¸ë¥¼ í•  ìˆ˜ ìˆë‹¤.
- ìŠ¤í”„ë§ì€ MailSenderë¼ëŠ” ë©”ì¼ ì„œë¹„ìŠ¤ ì¶”ìƒí™”í™” í•´ì£¼ëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•œë‹¤.

### í…ŒìŠ¤íŠ¸ì™€ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

- ì„œë¹„ìŠ¤ ì¶”ìƒí™”ëŠ” JavaMailì˜ ê²½ìš° ì²˜ëŸ¼ í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê¸° ì–´ë ¤ìš´ ë°©ì‹ìœ¼ë¡œ ì„¤ê³„ëœ APIë¥¼ ì‚¬ìš©í•  ë•Œë„ ìœ ìš©í•˜ê²Œ ì‚¬ìš©ëœë‹¤.
- ì„œë¹„ìŠ¤ ì¶”ìƒí™”ëŠ” ì›í• í•œ í…ŒìŠ¤íŠ¸ë§Œì„ ìœ„í•´ì„œë„ ê°€ì¹˜ê°€ ìˆë‹¤. í™•ì¥ì´ ë¶ˆê°€ëŠ¥í•˜ê²Œ ì„¤ê³„í•´ë†“ì€ APIë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ê²½ìš°ë¼ë©´ ì¶”ìƒí™” ê³„ì¸µì˜ ë„ì…ì„ ì ê·¹ ê³ ë ¤í•´ë³¼ í•„ìš”ê°€ ìˆë‹¤.

### í…ŒìŠ¤íŠ¸ ëŒ€ì—­

- í…ŒìŠ¤íŠ¸ ëŒ€ì—­ì—ëŠ” ëŒ€í‘œì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ìŠ¤í…ê³¼ ëª© ì˜¤ë¸Œì íŠ¸ê°€ ìˆë‹¤.
- ìŠ¤í…ì€ ìƒíƒœë¥¼ ê²€ì¦í•˜ì§€ë§Œ ëª©ì€ í–‰ìœ„ë¥¼ ê²€ì¦í•œë‹¤.

> ğŸ“ŒÂ  í…ŒìŠ¤íŠ¸ ëŒ€ì—­(Test Double)
> 
> - í…ŒìŠ¤íŠ¸ í™˜ê²½ì„ ë§Œë“¤ì–´ì£¼ê¸° ìœ„í•´, í…ŒìŠ¤íŠ¸ ëŒ€ìƒì´ ë˜ëŠ” ì˜¤ë¸Œì íŠ¸ì˜ ê¸°ëŠ¥ì—ë§Œ ì¶©ì‹¤í•˜ê²Œ ìˆ˜í–‰í•˜ë©´ì„œ ë¹ ë¥´ê²Œ, ìì£¼ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ì‚¬ìš©í•˜ëŠ” ì˜¤ë¸Œì íŠ¸

> ğŸ“ŒÂ  í…ŒìŠ¤íŠ¸ ìŠ¤í…(Test Stub)
> 
> - í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ì˜¤ë¸Œì íŠ¸ì˜ ì˜ì¡´ê°ì²´ë¡œì„œ ì¡´ì¬í•˜ë©´ì„œ í…ŒìŠ¤íŠ¸ ë™ì•ˆì— ì½”ë“œê°€ ì •ìƒì ìœ¼ë¡œ ìˆ˜í–‰í•  ìˆ˜ ìˆë„ë¡ ë•ëŠ” ì˜¤ë¸Œì íŠ¸(ì‹¤ì œë¡œ ë™ì‘í•˜ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì´ê²Œ ë§Œë“œëŠ” ì˜¤ë¸Œì íŠ¸)
> - ë©”ì†Œë“œë¥¼ í†µí•´ ì „ë‹¬í•˜ëŠ” íŒŒë¼ë¯¸í„°ì™€ ë‹¬ë¦¬ í…ŒìŠ¤íŠ¸ ì½”ë“œ ë‚´ë¶€ì—ì„œ ê°„ì ‘ì ìœ¼ë¡œ ì‚¬ìš©ëœë‹¤.
> - ì‚¬ìš©í•  ë•ŒëŠ” DI ë“±ì„ í†µí•´ ë¯¸ë¦¬ ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ë¥¼ í…ŒìŠ¤íŠ¸ ìŠ¤í…ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•œë‹¤.
> - í…ŒìŠ¤íŠ¸ ìŠ¤í…ì„ ì´ìš©í•œ í…ŒìŠ¤íŠ¸ ë„ì¤‘ ê²°ê³¼ë¥¼ ëŒë ¤ì¤˜ì•¼ í•  ê²½ìš°ë„ ìˆëŠ”ë° ìŠ¤í…ì— ë¯¸ë¦¬ í•„ìš”í•œ ì •ë³´ë¥¼ ë¦¬í„´í•˜ë„ë¡ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.

> ğŸ“ŒÂ  ëª© ì˜¤ë¸Œì íŠ¸(Mock Obejct)
> 
> - í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ì˜¤ë¸Œì íŠ¸ì™€ ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ ì‚¬ì´ì—ì„œ ì¼ì–´ë‚˜ëŠ” ì¼ì„ ê²€ì¦í•  ìˆ˜ ìˆë„ë¡ íŠ¹ë³„íˆ ì„¤ê³„ëœ ì˜¤ë¸Œì íŠ¸(í˜¸ì¶œì— ëŒ€í•œ ê¸°ëŒ€ë¥¼ ëª…ì„¸í•˜ê³ , ë‚´ìš©ì— ë”°ë¼ ë™ì‘í•˜ë„ë¡ í”„ë¡œê·¸ë˜ë° ëœ ì˜¤ë¸Œì íŠ¸)
> - í…ŒìŠ¤íŠ¸ ëŒ€ìƒì˜ ê°„ì ‘ì ì¸ ì¶œë ¥ ê²°ê³¼ë¥¼ ê²€ì¦í•œë‹¤.
