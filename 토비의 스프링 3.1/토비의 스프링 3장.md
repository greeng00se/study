> í† ë¹„ì˜ ìŠ¤í”„ë§ 3.1ì„ ì½ê³  ì •ë¦¬í•œ ê¸€ì…ë‹ˆë‹¤.
> 

## 3. í…œí”Œë¦¿

### ëª©í‘œ

- ìŠ¤í”„ë§ì— ì ìš©ëœ í…œí”Œë¦¿ ê¸°ë²•
- ì™„ì„±ë„ ìˆëŠ” DAO ì½”ë“œ

## 3.1 ë‹¤ì‹œ ë³´ëŠ” ì´ˆë‚œê° DAO

### JDBC ì˜ˆì™¸ì²˜ë¦¬

- JDBCì½”ë“œì˜ íë¦„ì„ ë”°ë¥´ì§€ ì•Šê³  ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ê²½ìš° ê°€ì ¸ì˜¨ ë¦¬ì†ŒìŠ¤ë¥¼ `close()` ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•´ì„œ ë°˜í™˜ì„ í•´ì•¼ í•œë‹¤.
- ì´ë•Œ NPEë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ì„œ í•´ë‹¹ ë¦¬ì†ŒìŠ¤ê°€ nullì´ ì•„ë‹Œì§€ í™•ì¸í•˜ê³  ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤.

## 3.2 ë³€í•˜ëŠ” ê²ƒê³¼ ë³€í•˜ì§€ ì•ŠëŠ” ê²ƒ

> â—Â  JDBC try/catch/finally ì½”ë“œì˜ ë¬¸ì œì 
> 
> - ì¤‘ì²©ê³¼ ë°˜ë³µì´ ë§ì•„ ë³µì¡í•˜ë‹¤.
> - ì²˜ìŒì— ì™„ë²½í•˜ê²Œ ì‘ì„±í•˜ë”ë¼ë„ ìˆ˜ì •ì´ ê³„ì†ë¨ìœ¼ë¡œ ì‹¤ìˆ˜ë¥¼ í•  ê°€ëŠ¥ì„±ì´ ë†’ì•„ì§„ë‹¤.

### í…œí”Œë¦¿ ë©”ì†Œë“œ ì ìš©

- ìƒìœ„ DAO í´ë˜ìŠ¤ì— ë¶ˆí•„ìš”í•œ ë³€í™”ëŠ” ìƒê¸°ì§€ ì•Šë„ë¡ í•  ìˆ˜ ìˆë‹¤.
- í˜„ì¬ JDBC ì½”ë“œì—ì„œ í…œí”Œë¦¿ ë©”ì†Œë“œ íŒ¨í„´ì„ ì‚¬ìš©í•˜ë©´ JDBC ë©”ì†Œë“œê°€ ëŠ˜ì–´ë‚ ìˆ˜ë¡ ì„œë¸Œí´ë˜ìŠ¤ì˜ ìˆ˜ê°€ ëŠ˜ì–´ë‚œë‹¤.

```java
abstract protected PreparedStatement makeStatement(Connection c) throws SQLException;
```

- ë³€í•˜ëŠ” ë¶€ë¶„ì„ ì¶”ìƒ ë©”ì†Œë“œë¡œ ì •ì˜í•œë‹¤.

```java
public class UserDaoDeleteAll extends UserDao {

    protected PreparedStatement makeStatement(Connection c) throws SQLException {
        return c.prepareStatement("delete from users");
    }
}
```

- ì„œë¸Œí´ë˜ìŠ¤ì—ì„œ ì˜¤ë¸Œë¼ì´ë“œí•˜ì—¬ ìƒˆë¡­ê²Œ ì •ì˜í•œë‹¤.

> ğŸ“ŒÂ  í…œí”Œë¦¿ ë©”ì†Œë“œ íŒ¨í„´(Template Method Pattern)
> 
> - ìƒì†ì„ í†µí•´ ê¸°ëŠ¥ì„ í™•ì¥í•´ì„œ ì‚¬ìš©
> - ë³€í•˜ì§€ ì•ŠëŠ” ë¶€ë¶„ì€ ìŠˆí¼í´ë˜ìŠ¤ì— ë‘ê³  ë³€í•˜ëŠ” ë¶€ë¶„ì€ ì¶”ìƒ ë©”ì†Œë“œë¡œ ì •ì˜í•´ì„œ ì„œë¸Œí´ë˜ìŠ¤ì—ì„œ ì˜¤ë²„ë¼ì´ë“œí•˜ì—¬ ìƒˆë¡­ê²Œ ì •ì˜í•´ ì‚¬ìš©í•˜ë„ë¡ í•˜ëŠ” íŒ¨í„´

### ì „ëµ íŒ¨í„´ì˜ ì ìš©

- ë³€í•˜ëŠ” ë¶€ë¶„ì¸ PreparedStatementì„ ë§Œë“¤ì–´ì£¼ëŠ” ë¶€ë¶„ì´ ì „ëµì— í•´ë‹¹ëœë‹¤.
- í•´ë‹¹ ê¸°ëŠ¥ì„ ì¸í„°í˜ì´ìŠ¤ë¡œ ë§Œë“¤ì–´ë‘ê³  ì¸í„°í˜ì´ìŠ¤ì˜ ë©”ì†Œë“œë¥¼ í†µí•´ ìƒì„± ì „ëµì„ í˜¸ì¶œí•´ì£¼ë©´ ëœë‹¤.

```java
public interface StatementStrategy {
    PreparedStatement makePreparedStatement(Connection c) throws SQLException;
}
```

- ì „ëµì˜ ì¸í„°í˜ì´ìŠ¤ì— í•´ë‹¹í•˜ëŠ” StatementStrategy

```java
public class DeleteAllStatement implements StatementStrategy {
    @Override
    public PreparedStatement makePreparedStatement(Connection c) throws SQLException {
        return c.prepareStatement("delete from users");
    }
}
```

- ì¸í„°í˜ì´ìŠ¤ë¥¼ ìƒì†í•œ ì‹¤ì œ ì „ëµ

> ğŸ“ŒÂ  ì „ëµ íŒ¨í„´(Strategy Pattern)
> 
> - ì˜¤ë¸Œì íŠ¸ë¥¼ ë‘˜ë¡œ ë¶„ë¦¬í•˜ê³  í´ë˜ìŠ¤ ë ˆë²¨ì—ì„œëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ì„œë§Œ ì˜ì¡´í•˜ë„ë¡ ë§Œë“œëŠ” íŒ¨í„´
> - í™•ì¥ì— í•´ë‹¹í•˜ëŠ” ë³€í•˜ëŠ” ë¶€ë¶„ì„ ë³„ë„ì˜ í´ë˜ìŠ¤ë¡œ ë§Œë“¤ì–´ ì¶”ìƒí™”ëœ ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ ìœ„ì„í•˜ëŠ” ë°©ì‹

### DI ì ìš©ì„ ìœ„í•œ í´ë¼ì´ì–¸íŠ¸/ì»¨í…ìŠ¤íŠ¸ ë¶„ë¦¬

![image](https://user-images.githubusercontent.com/58586537/168477480-bc4b5476-28c3-450c-860c-acd774aef0d8.png)

- ì „ëµ íŒ¨í„´ì— ë”°ë¥´ë©´ Contextê°€ ì–´ë–¤ ì „ëµì„ ì‚¬ìš©í•˜ê²Œ í•  ê²ƒì¸ê°€ëŠ” Contextë¥¼ ì‚¬ìš©í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ì„ íƒí•˜ëŠ” ê²ƒì´ ì¼ë°˜ì ì´ë‹¤.

```java
public void deleteAll() throws ClassNotFoundException, SQLException {
    StatementStrategy st = new DeleteAllStatement();
    jdbcContextWithStatementStrategy(st);
}
```

- í´ë¼ì´ì–¸íŠ¸ê°€ ì „ëµ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ê³  ì˜¤ë¸Œì íŠ¸ë¡œ ë§Œë“¤ì–´ì„œ Contextì— ì „ë‹¬í•˜ë©´ ëœë‹¤.

```java
public void jdbcContextWithStatementStrategy(StatementStrategy stmt) throws SQLException, ClassNotFoundException {
    Connection c = null;
    PreparedStatement ps = null;

    try {
        c = connectionMaker.makeConnection();
        ps = stmt.makePreparedStatement(c);

        ps.executeUpdate();
    } catch (SQLException e) {
        throw e;
    } finally {
        if (ps != null) { try { ps.close(); } catch (SQLException e) {} }
        if (c != null) { try { c.close(); } catch (SQLException e) {} }
    }
}
```

- ì»¨í…ìŠ¤íŠ¸ëŠ” ì œê³µë°›ì€ ì „ëµì„ í•„ìš”í•œ ì‹œì ì— í˜¸ì¶œí•´ì„œ ì‚¬ìš©í•˜ë©´ ëœë‹¤.
- ìœ„ êµ¬ì¡°ëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ì»¨í…ìŠ¤íŠ¸ê°€ ì‚¬ìš©í•  ì „ëµì„ ì •í•´ì„œ ì „ë‹¬í•œë‹¤ëŠ” ë©´ì—ì„œ DI êµ¬ì¡°ë¼ê³  ì´í•´í•  ìˆ˜ ìˆë‹¤.

> ğŸ“ŒÂ  ë§ˆì´í¬ë¡œ DI
> 
> - DIì˜ ê°€ì¥ ì¤‘ìš”í•œ ê°œë…ì€ ì œ 3ìì˜ ë„ì›€ì„ í†µí•´ ë‘ ì˜¤ë¸Œì íŠ¸ ì‚¬ì´ì˜ ìœ ì—°í•œ ê´€ê³„ê°€ ì„¤ì •ë˜ëŠ” ê²ƒ
> - DIì˜ ì¥ì ì„ ë‹¨ìˆœí™”í•´ì„œ IoC ì»¨í…Œì´ë„ˆ ë„ì›€ ì—†ì´ ì½”ë“œ ë‚´ì—ì„œ ì ìš©í•œ ê²½ìš°ë¥¼ ë§ˆì´í¬ë¡œ DI ë˜ëŠ” ì½”ë“œì— ì˜í•œ DIë¼ëŠ” ì˜ë¯¸ë¡œ ìˆ˜ë™ DIë¼ê³  í•  ìˆ˜ ìˆë‹¤.

## 3.3 JDBC ì „ëµ íŒ¨í„´ì˜ ìµœì í™”

### ì „ëµê³¼ í´ë¼ì´ì–¸íŠ¸

> â—Â ì „ëµ êµ¬í˜„ í´ë˜ìŠ¤ì˜ ë¬¸ì œì 
> 
> - DAO ë©”ì†Œë“œë§ˆë‹¤ ìƒˆë¡œìš´ ì „ëµì˜ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ë©´ í´ë˜ìŠ¤ íŒŒì¼ì˜ ê°œìˆ˜ê°€ ëŠ˜ì–´ë‚œë‹¤.
> - ì¶”ê°€ì ìœ¼ë¡œ ì „ë‹¬í•  ì •ë³´ê°€ ìˆì„ ê²½ìš° ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ë¥¼ ë²ˆê±°ë¡­ê²Œ ë§Œë“¤ì–´ì•¼ í•œë‹¤.
- ìœ„ ë¬¸ì œë¥¼ ìµëª… í´ë˜ìŠ¤ë¡œ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

```java
public void add(final User user) throws ClassNotFoundException, SQLException {
    jdbcContextWithStatementStrategy(
        new StatementStrategy() {
            @Override
            public PreparedStatement makePreparedStatement(Connection c) throws SQLException {
                PreparedStatement ps = c.prepareStatement(
                        "insert into users(id, name, password) values(?, ?, ?)");

                ps.setString(1, user.getId());
                ps.setString(2, user.getName());
                ps.setString(3, user.getPassword());

                return ps;
            }
        }
    );
}
```

- UserDaoì˜ StatementStrategyë¥¼ êµ¬í˜„í•œ ìµëª… ë‚´ë¶€ í´ë˜ìŠ¤

### í˜„ì¬ê¹Œì§€ ì •ë¦¬

![image](https://user-images.githubusercontent.com/58586537/168477513-01a1c63f-fc2a-4e5c-90f3-911f6a33807e.png)

## 3.4 ì»¨í…ìŠ¤íŠ¸ì™€ DI

### JdbcContextì˜ ë¶„ë¦¬

- JDBCì˜ ì¼ë°˜ì ì¸ ì‘ì—… íë¦„ì„ ë‹´ê³ ìˆëŠ” ì»¨í…ìŠ¤íŠ¸ëŠ” ë‹¤ë¥¸ DAOì—ì„œë„ ì‚¬ìš©í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ë¶„ë¦¬ ê°€ëŠ¥í•˜ë‹¤.

### êµ¬ì²´ í´ë˜ìŠ¤ì˜ DI

- ìŠ¤í”„ë§ì˜ DIëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ì´ì— ë‘ê³  ì˜ì¡´ í´ë˜ìŠ¤ë¥¼ ë°”ê¿”ì„œ ì‚¬ìš©í•˜ë„ë¡ í•˜ëŠ”ê²Œ ëª©ì ì´ë‹¤.
- í´ë˜ìŠ¤ë¥¼ ë°”ë¡œ ì‚¬ìš©í•˜ëŠ” ì½”ë“œ êµ¬ì„±ì„ DIì— ì ìš©í•˜ëŠ” ê²ƒì€ ë§ˆì§€ë§‰ ë‹¨ê³„ì—ì„œ ê³ ë ¤í•  ì‚¬í•­
- ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ DI
    - ì‹±ê¸€í†¤ ë¹ˆìœ¼ë¡œ ì—¬ëŸ¬ ì˜¤ë¸Œì íŠ¸ì—ì„œ ê³µìœ í•´ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
    - ì¥ì : ì˜¤ë¸Œì íŠ¸ ì‚¬ì´ì˜ ì‹¤ì œ ì˜ì¡´ê´€ê³„ê°€ ì„¤ì • íŒŒì¼ì— ëª…í™•í•˜ê²Œ ë“œëŸ¬ë‚œë‹¤.
    - ë‹¨ì : ê·¼ë³¸ì ì¸ ì›ì¹™(ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ì´ì— ë‘ê³  DI)ì— ë¶€í•©í•˜ì§€ ì•ŠëŠ” êµ¬ì²´ì ì¸ í´ë˜ìŠ¤ì™€ì˜ ê´€ê³„ê°€ ì„¤ì •ì— ë…¸ì¶œëœë‹¤.
- ì½”ë“œë¥¼ ì‚¬ìš©í•˜ëŠ” ìˆ˜ë™ DI
    - ì¥ì : ê´€ê³„ë¥¼ ì™¸ë¶€ì— ë“œëŸ¬ë‚´ì§€ ì•ŠëŠ”ë‹¤.
    - ë‹¨ì : êµ¬ì²´ í´ë˜ìŠ¤ë¥¼ ì‹±ê¸€í†¤ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ê³  DIë¥¼ ìœ„í•´ì„œ ë¶€ê°€ì ì¸ ì½”ë“œê°€ í•„ìš”í•˜ë‹¤.

## 3.5 í…œí”Œë¦¿ê³¼ ì½œë°±

> ğŸ“ŒÂ  í…œí”Œë¦¿/ì½œë°± íŒ¨í„´(Template Callback Pattern)
> 
> - ì „ëµ íŒ¨í„´ì˜ ê¸°ë³¸ êµ¬ì¡°ì— ìµëª… ë‚´ë¶€ í´ë˜ìŠ¤ë¥¼ í™œìš©í•œ ë°©ì‹
> - í…œí”Œë¦¿ â†’ ì „ëµ íŒ¨í„´ì˜ ì»¨í…ìŠ¤íŠ¸
> - ì½œë°± â†’ ìµëª… ë‚´ë¶€ í´ë˜ìŠ¤ë¡œ ë§Œë“¤ì–´ì§€ëŠ” ì˜¤ë¸Œì íŠ¸

### í…œí”Œë¦¿/ì½œë°±ì˜ ë™ì‘ì›ë¦¬

- í…œí”Œë¦¿ì€ ê³ ì •ëœ ì‘ì—… íë¦„ì„ ê°€ì§„ ì½”ë“œë¥¼ ì¬ì‚¬ìš©í•œë‹¤ëŠ” ì˜ë¯¸ì—ì„œ ë¶™ì¸ ì´ë¦„ì´ë‹¤.
- ì½œë°±ì€ í…œí”Œë¦¿ ì•ˆì—ì„œ í˜¸ì¶œë˜ëŠ” ê²ƒì„ ëª©ì ìœ¼ë¡œ ë§Œë“¤ì–´ì§„ ì˜¤ë¸Œì íŠ¸ë¥¼ ë§í•œë‹¤.
    - ì¼ë°˜ì ìœ¼ë¡œ í•˜ë‚˜ì˜ ë©”ì†Œë“œë¥¼ ê°€ì§„ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ ìµëª… ë‚´ë¶€ í´ë˜ìŠ¤ë¡œ ë§Œë“¤ì–´ì§„ë‹¤.
    

### í…œí”Œë¦¿/ì½œë°±ì˜ ì‘ì—… íë¦„

1. í´ë¼ì´ì–¸íŠ¸ëŠ” í…œí”Œë¦¿ì•ˆì—ì„œ ì‹¤í–‰ë¡œì§ì´ ë‹´ê¸´ ì½œë°± ì˜¤ë¸Œì íŠ¸ë¥¼ ìƒì„±í•´ì„œ í…œí”Œë¦¿ì˜ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•  ë•Œ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•œë‹¤.
2. í…œí”Œë¦¿ì€ ì‘ì—… íë¦„ì— ë”°ë¼ ì½œë°± ì˜¤ë¸Œì íŠ¸ì˜ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ê³  ê²°ê³¼ë¥¼ í…œí”Œë¦¿ì— ëŒë ¤ì¤€ë‹¤.
3. í…œí”Œë¦¿ì€ ì½œë°±ì´ ë¦¬í„´í•œ ì •ë³´ë¥¼ ì‚¬ìš©í•´ì„œ ì‘ì—…ì„ ìˆ˜í–‰í•œë‹¤.

### í…œí”Œë¦¿/ì½œë°± íŒ¨í„´ ì ìš© ìˆœì„œ

- ì½”ë“œ ë¶„ë¦¬ â†’ ê³ ì •ëœ ë°˜ë³µ íë¦„ì„ ê°€ì§€ê³  ìˆìœ¼ë©´ì„œ ìì£¼ ë°˜ë³µë  ê²½ìš°
- ì „ëµíŒ¨í„´ ì ìš© â†’ ì¼ë¶€ ì‘ì—…ì„ í•„ìš”ì— ë”°ë¼ ë°”ê¾¸ì–´ ì‚¬ìš©í•  ê²½ìš°
    - ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ì´ì— ë‘ê³  ë¶„ë¦¬í•œ ë’¤ DIë¡œ ì˜ì¡´ê´€ê³„ë¥¼ ê´€ë¦¬í•˜ë„ë¡ ë§Œë“ ë‹¤.
- í…œí”Œë¦¿/ì½œë°± íŒ¨í„´ì„ ì ìš© â†’ ë°”ë€ŒëŠ” ë¶€ë¶„ì´ í•œ ì–´í”Œë¦¬ì¼€ì´ì…˜ ì•ˆì—ì„œ ë™ì‹œì— ì—¬ëŸ¬ ì¢…ë¥˜ê°€ ë§Œë“¤ì–´ì§ˆ ìˆ˜ ìˆì„ ê²½ìš°

### í…œí”Œë¦¿/ì½œë°±ì˜ í›„ë³´

- try/catch/finally ë¸”ë¡ì„ ì‚¬ìš©í•˜ëŠ” ì½”ë“œ

## 3.6 ìŠ¤í”„ë§ì˜ JdbcTemplate

### JdbcTemplate

- ìŠ¤í”„ë§ì€ JDBCë¥¼ ì´ìš©í•˜ëŠ” DAOì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë‹¤ì–‘í•œ í…œí”Œë¦¿, ì½œë°±ì„ ì œê³µí•œë‹¤.
    - query, update, queryForObjectë“± ì—¬ëŸ¬ í…œí”Œë¦¿ ë©”ì†Œë“œë“¤ì„ ì œê³µí•œë‹¤.
    

### í…ŒìŠ¤íŠ¸ ë³´ì™„

- ë„¤ê±°í‹°ë¸Œ í…ŒìŠ¤íŠ¸, ì˜ˆì™¸ì ì¸ ìƒí™©ì„ ì˜ ê³ ë ¤í•´ì•¼ í•œë‹¤.

### JdbcTemplateì„ ì ìš©í•œ UserDao

```java
public class UserDao {

    private JdbcTemplate jdbcTemplate;

    private RowMapper<User> userMapper = new RowMapper<User>() {
        @Override
        public User mapRow(ResultSet rs, int rowNum) throws SQLException {
            User user = new User();
            user.setId(rs.getString("id"));
            user.setName(rs.getString("name"));
            user.setPassword(rs.getString("password"));
            return user;
        }
    };

    public void setDataSource(DataSource dataSource) {
        this.jdbcTemplate = new JdbcTemplate(dataSource);
    }

    public void add(final User user) {
        this.jdbcTemplate.update("insert into users(id, name, password) values(?, ?, ?)",
                user.getId(), user.getName(), user.getPassword());
    }

    public User get(String id) {
        return this.jdbcTemplate.queryForObject("select * from users where id = ?",
                this.userMapper, new Object[]{id});
    }

    public void deleteAll() {
        this.jdbcTemplate.update("delete from users");
    }

    public int getCount() {
        return this.jdbcTemplate.queryForObject("select count(*) from users", Integer.class);
    }

    public List<User> getAll() {
        return this.jdbcTemplate.query("select * from users order by id", this.userMapper);
    }
}
```
